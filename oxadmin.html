<!DOCTYPE html>
<html lang="ko" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <title>OX 퀴즈 관리자</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .header-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .status-waiting { background: #fbbf24; }
        .status-active { background: #3b82f6; }
        .status-ended { background: #ef4444; }
        .pulse { animation: pulse 2s infinite; }
        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%);
            transform: translateY(-1px);
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        
    </style>
</head>
<body class="min-h-screen">
    <!-- 로그인 -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-6">
        <div class="card rounded-3xl p-8 w-full max-w-md">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">OX 퀴즈 관리자</h1>
            <input type="password" id="adminPassword" class="w-full px-4 py-3 border rounded-xl mb-4" placeholder="관리자 비밀번호">
            <button onclick="login()" class="w-full py-3 bg-blue-500 text-white rounded-xl font-semibold hover:bg-blue-600">로그인</button>
        </div>
    </div>

    <!-- 관리자 메인 -->
    <div id="adminApp" class="hidden min-h-screen flex flex-col">
        <!-- 헤더 -->
        <div class="header-gradient p-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-white">OX 퀴즈 관리자</h1>
                    <div class="flex items-center mt-1">
                        <div id="statusDot" class="w-3 h-3 rounded-full mr-2 status-waiting"></div>
                        <span class="text-white text-opacity-80" id="statusText">대기 중</span>
                    </div>
                </div>
                <button onclick="logout()" class="text-white text-opacity-70 hover:text-white">로그아웃</button>
            </div>
        </div>

        <div class="flex-1 p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- 게임 제어 -->
                <div class="card rounded-3xl p-6">
                    <h2 class="text-xl font-bold mb-4">게임 제어</h2>
                    
                    <!-- 문제 선택 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">문제 선택</label>
                        <select id="questionSelect" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">문제를 선택하세요</option>
                        </select>
                    </div>
                    
                    <!-- 보너스 토글 -->
                    <div class="mb-6 p-3 bg-orange-50 rounded-lg">
                        <label class="flex items-center">
                            <input type="checkbox" id="bonusToggle" class="mr-2">
                            <span class="text-orange-800">⭐ 보너스 문제 (2배 점수)</span>
                        </label>
                    </div>
                    
                    <!-- 제어 버튼 -->
                    <div class="space-y-3">
                        <button onclick="startQuestion()" id="btnStart" class="w-full py-3 bg-green-500 text-white rounded-xl font-semibold hover:bg-green-600">🚀 문제 시작</button>
                        <button onclick="endQuestion()" id="btnEnd" disabled class="w-full py-3 bg-orange-500 text-white rounded-xl font-semibold disabled:bg-gray-400">⏹️ 문제 종료</button>
                        <button onclick="nextQuestion()" id="btnNext" disabled class="w-full py-3 bg-blue-500 text-white rounded-xl font-semibold disabled:bg-gray-400">📝 다음 문제</button>
                        <button onclick="resetGame()" class="w-full py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600">🔄 전체 리셋</button>
                    </div>
                    
                    <!-- 현재 문제 정보 -->
                    <div class="mt-6">
                        <h3 class="font-bold mb-2">현재 문제</h3>
                        <div id="currentQuestionInfo" class="text-gray-500 text-sm">선택된 문제가 없습니다</div>
                    </div>
                </div>

                <!-- 문제 관리 -->
                <div class="card rounded-3xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">문제 관리</h2>
                        <button onclick="toggleForm()" id="btnToggle" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">+ 새 문제</button>
                    </div>
                    
                    <!-- 문제 추가 폼 -->
                    <div id="questionForm" class="hidden mb-4 p-4 bg-gray-50 rounded-lg">
                        <input type="text" id="questionTitle" class="w-full px-3 py-2 border rounded-lg mb-3" placeholder="문제 제목">
                        <select id="correctAnswer" class="w-full px-3 py-2 border rounded-lg mb-3">
                            <option value="O">O</option>
                            <option value="X">X</option>
                        </select>
                        <input type="file" id="questionImage" accept="image/*" class="w-full px-3 py-2 border rounded-lg mb-3">
                        <div id="imagePreview" class="mb-3 hidden">
                            <img id="previewImg" class="max-w-full h-32 object-contain border rounded" alt="미리보기">
                            <button type="button" onclick="clearImage()" class="mt-2 px-2 py-1 bg-red-500 text-white rounded text-xs">이미지 제거</button>
                        </div>
                        <label class="flex items-center mb-3">
                            <input type="checkbox" id="isBonus" class="mr-2">
                            <span class="text-sm">기본 보너스 문제</span>
                        </label>
                        <div class="flex space-x-2">
                            <button onclick="saveQuestion()" class="flex-1 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600">저장</button>
                            <button onclick="cancelForm()" class="px-4 py-2 bg-gray-500 text-white rounded-lg text-sm hover:bg-gray-600">취소</button>
                        </div>
                    </div>
                    
                    <!-- 문제 목록 -->
                    <div id="questionList" class="space-y-2 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 py-8">저장된 문제가 없습니다</div>
                    </div>
                </div>

                <!-- 실시간 현황 & 랭킹 -->
                <div class="space-y-6">
                    <!-- 실시간 현황 -->
                    <div class="card rounded-3xl p-6">
                        <h2 class="text-xl font-bold mb-4">실시간 현황</h2>
                        <div id="liveStats">
                            <div class="text-center text-gray-500 py-8">문제가 진행되지 않고 있습니다</div>
                        </div>
                    </div>
                    
                    <!-- 사용자 관리 -->
                    <div class="card rounded-3xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">사용자 관리</h2>
                            <button onclick="toggleRankingView()" id="btnRankingToggle" class="px-3 py-1 bg-purple-500 text-white rounded text-sm hover:bg-purple-600">랭킹보기</button>
                        </div>
                        <div id="userList" class="space-y-2 max-h-64 overflow-y-auto">
                            <div class="text-center text-gray-500 py-8">사용자를 불러오는 중...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, orderBy, updateDoc, deleteDoc, getDocs, writeBatch, increment, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

        const app = initializeApp({
            apiKey: "AIzaSyA_SuKTn4jWyBL3lyk8CK6hPpttpR0MOMc",
            authDomain: "quizland-hyogi.firebaseapp.com",
            projectId: "quizland-hyogi",
            storageBucket: "quizland-hyogi.firebasestorage.app",
            messagingSenderId: "886372179569",
            appId: "1:886372179569:web:8616d019f7b63a26e045d0"
        });
        const db = getFirestore(app);
        const storage = getStorage(app);  // 이 줄 추가

        let currentQuestion = null, questions = [], listeners = [], editingId = null;
        // 랭킹 토글 함수 추가
        let showRankingMode = false;

        let currentUsersSnapshot = null;  // 전역 변수로 추가
        
        window.toggleRankingView = () => {
            showRankingMode = !showRankingMode;
            const btn = document.getElementById('btnRankingToggle');
            if (showRankingMode) {
                btn.textContent = '관리모드';
                btn.className = 'px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600';
            } else {
                btn.textContent = '랭킹보기';
                btn.className = 'px-3 py-1 bg-purple-500 text-white rounded text-sm hover:bg-purple-600';
            }
            // 현재 스냅샷이 있을 때만 업데이트
            if (currentUsersSnapshot) {
                updateUsers(currentUsersSnapshot);
            }
        };

        // 로그인
        window.login = () => {
            if (document.getElementById('adminPassword').value === 'admin123') {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminApp').classList.remove('hidden');
                init();
            } else alert('잘못된 비밀번호입니다.');
        };

        // 초기화
        async function init() {
            setupListeners();
            await loadQuestions();
            document.getElementById('questionSelect').addEventListener('change', updateUI);
        }

        // 리스너 설정
        function setupListeners() {
            const questionListener = onSnapshot(doc(db, 'system', 'currentQuestion'), (doc) => {
                currentQuestion = doc.exists() ? doc.data() : null;
                updateUI();
            });
            
            const answersListener = onSnapshot(collection(db, 'answers'), updateStats);
            const usersListener = onSnapshot(query(collection(db, 'users'), orderBy('score', 'desc')), (snapshot) => {
                currentUsersSnapshot = snapshot;  // 스냅샷 저장
                updateUsers(snapshot);
            });
            
            listeners = [questionListener, answersListener, usersListener];
        }

        // UI 업데이트
        // 기존 updateUI() 함수에서 버튼 비활성화 부분 수정
        function updateUI() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const btnStart = document.getElementById('btnStart');
            const btnEnd = document.getElementById('btnEnd');
            const btnNext = document.getElementById('btnNext');
            const info = document.getElementById('currentQuestionInfo');
            const questionSelect = document.getElementById('questionSelect');
        
            if (!currentQuestion) {
                // 대기 상태
                statusDot.className = 'w-3 h-3 rounded-full mr-2 status-waiting';
                statusText.textContent = '대기 중';
                btnStart.disabled = questions.length === 0 || !questionSelect.value;
                btnStart.className = btnStart.disabled ? 
                    'w-full py-3 bg-gray-400 text-white rounded-xl font-semibold cursor-not-allowed' : 
                    'w-full py-3 bg-green-500 text-white rounded-xl font-semibold hover:bg-green-600';
                btnEnd.disabled = true;
                btnEnd.className = 'w-full py-3 bg-gray-400 text-white rounded-xl font-semibold cursor-not-allowed';
                btnNext.disabled = true;
                btnNext.className = 'w-full py-3 bg-gray-400 text-white rounded-xl font-semibold cursor-not-allowed';
                questionSelect.disabled = false;
                info.textContent = '문제를 선택하고 시작하세요';
            } else if (currentQuestion.status === 'active') {
                // 진행 중
                statusDot.className = 'w-3 h-3 rounded-full mr-2 status-active pulse';
                statusText.textContent = '문제 진행 중';
                btnStart.disabled = true;
                btnStart.className = 'w-full py-3 bg-gray-400 text-white rounded-xl font-semibold cursor-not-allowed';
                btnEnd.disabled = false;
                btnEnd.className = 'w-full py-3 bg-orange-500 text-white rounded-xl font-semibold hover:bg-orange-600';
                btnNext.disabled = true;
                btnNext.className = 'w-full py-3 bg-gray-400 text-white rounded-xl font-semibold cursor-not-allowed';
                questionSelect.disabled = true;  // 문제 진행 중에는 변경 불가
                const bonus = currentQuestion.isBonus ? ' ⭐' : '';
                info.innerHTML = `<div class="bg-blue-50 p-3 rounded">${currentQuestion.title}<br>정답: ${currentQuestion.correctAnswer}${bonus}</div>`;
            } else if (currentQuestion.status === 'ended') {
                // 종료됨
                statusDot.className = 'w-3 h-3 rounded-full mr-2 status-ended';
                statusText.textContent = '문제 종료됨';
                btnStart.disabled = true;
                btnStart.className = 'w-full py-3 bg-gray-400 text-white rounded-xl font-semibold cursor-not-allowed';
                btnEnd.disabled = true;
                btnEnd.className = 'w-full py-3 bg-gray-400 text-white rounded-xl font-semibold cursor-not-allowed';
                btnNext.disabled = false;
                btnNext.className = 'w-full py-3 bg-blue-500 text-white rounded-xl font-semibold hover:bg-blue-600';
                questionSelect.disabled = false;  // 다음 문제 선택 가능
                info.innerHTML = `<div class="bg-green-50 p-3 rounded">문제 종료됨<br>정답: ${currentQuestion.correctAnswer}</div>`;
            }
        }

        // 문제 시작
        window.startQuestion = async () => {
            const questionId = document.getElementById('questionSelect').value;
            if (!questionId) return alert('문제를 선택하세요');
            
            const question = questions.find(q => q.id === questionId);
            const isBonus = document.getElementById('bonusToggle').checked || question.isBonus;
            
            // 이전 답변 삭제
            const answers = await getDocs(collection(db, 'answers'));
            const batch = writeBatch(db);
            answers.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            
            // startQuestion 함수에서 이미지 데이터도 포함
            await setDoc(doc(db, 'system', 'currentQuestion'), {
                id: `q_${Date.now()}`,
                title: question.title,
                correctAnswer: question.correctAnswer,
                isBonus: isBonus,
                imageUrl: question.imageUrl || null,  // imageData → imageUrl로 변경
                status: 'active',
                startTime: serverTimestamp()
            });
            
            document.getElementById('bonusToggle').checked = false;
        };

        // 수정된 코드
        window.endQuestion = async () => {
            if (!currentQuestion) return;
            
            console.log('문제 종료 시작');
            
            // 먼저 점수 계산
            await calculateScores();
            
            // 그 다음 문제 상태를 종료로 변경
            await updateDoc(doc(db, 'system', 'currentQuestion'), { 
                status: 'ended', 
                endTime: serverTimestamp() 
            });
            
            console.log('문제 종료 완료');
        };

        // 수정된 코드
        async function calculateScores() {
            if (!currentQuestion) {
                console.log('현재 문제가 없습니다');
                return;
            }
            
            try {
                console.log('점수 계산 시작 - 문제 ID:', currentQuestion.id);
                console.log('정답:', currentQuestion.correctAnswer);
                
                const answers = await getDocs(collection(db, 'answers'));
                const points = currentQuestion.isBonus ? 2 : 1;
                
                let correctCount = 0;
                let totalCount = 0;
                
                // batch 대신 개별 업데이트로 변경
                const updatePromises = [];
                
                answers.forEach(answerDoc => {  // 파라미터 이름 변경
                    const answer = answerDoc.data();
                    console.log('답변 확인:', answer);
                    
                    if (answer.questionId === currentQuestion.id) {
                        totalCount++;
                        console.log(`${answer.userName}의 답변: ${answer.answer}`);
                        
                        if (answer.answer === currentQuestion.correctAnswer) {
                            correctCount++;
                            console.log(`${answer.userName} 정답! ${points}점 추가`);
                            
                            // doc 함수를 올바르게 사용
                            const userRef = doc(db, 'users', answer.userId);
                            updatePromises.push(updateDoc(userRef, { 
                                score: increment(points)
                            }));
                        }
                    }
                });
                
                // 모든 업데이트 실행
                await Promise.all(updatePromises);
                console.log(`점수 계산 완료: ${correctCount}/${totalCount}명 정답, ${points}점씩 지급`);
                
            } catch (error) {
                console.error('점수 계산 오류:', error);
            }
        }

        // 다음 문제
        window.nextQuestion = async () => {
            await deleteDoc(doc(db, 'system', 'currentQuestion'));
            document.getElementById('questionSelect').value = '';
        };

        // 전체 리셋
        window.resetGame = async () => {
            if (!confirm('정말 리셋하시겠습니까?\n모든 사용자의 점수와 답변 기록이 삭제됩니다.')) return;
            
            try {
                console.log('전체 리셋 시작...');
                
                // 1. 모든 답변 삭제
                const answers = await getDocs(collection(db, 'answers'));
                const batch1 = writeBatch(db);
                answers.forEach(doc => batch1.delete(doc.ref));
                await batch1.commit();
                console.log('답변 기록 삭제 완료');
                
                // 2. 모든 사용자 점수 리셋
                const users = await getDocs(collection(db, 'users'));
                const batch2 = writeBatch(db);
                users.forEach(doc => {
                    batch2.update(doc.ref, { score: 0 });
                });
                await batch2.commit();
                console.log('사용자 점수 리셋 완료');
                
                // 3. 현재 문제 삭제
                await deleteDoc(doc(db, 'system', 'currentQuestion'));
                console.log('현재 문제 삭제 완료');
                
                // 4. UI 초기화
                document.getElementById('questionSelect').value = '';
                
                alert('리셋이 완료되었습니다.');
                console.log('전체 리셋 완료');
                
            } catch (error) {
                console.error('리셋 오류:', error);
                alert('리셋 중 오류가 발생했습니다.');
            }
        };

        // 문제 관리
        window.toggleForm = () => {
            const form = document.getElementById('questionForm');
            const btn = document.getElementById('btnToggle');
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.textContent = '취소';
                btn.className = 'px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600';
            } else cancelForm();
        };
            // 이미지 미리보기 기능
            document.addEventListener('DOMContentLoaded', () => {
                const imageInput = document.getElementById('questionImage');
                if (imageInput) {
                    imageInput.addEventListener('change', handleImageSelect);
                }
            });
            
            function handleImageSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('previewImg').src = e.target.result;
                        document.getElementById('imagePreview').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            window.clearImage = () => {
                document.getElementById('questionImage').value = '';
                document.getElementById('imagePreview').classList.add('hidden');
            };
            
            async function uploadImageToStorage() {
                const fileInput = document.getElementById('questionImage');
                const file = fileInput.files[0];
                
                if (!file) return null;
                
                try {
                    console.log('이미지 업로드 시작:', file.name);
                    
                    // 파일명을 고유하게 만들기
                    const timestamp = Date.now();
                    const fileName = `question_${timestamp}_${file.name}`;
                    const imageRef = ref(storage, `question-images/${fileName}`);
                    
                    // 업로드 진행
                    const snapshot = await uploadBytes(imageRef, file);
                    console.log('업로드 완료');
                    
                    // 다운로드 URL 가져오기
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    console.log('다운로드 URL:', downloadURL);
                    
                    return downloadURL;
                } catch (error) {
                    console.error('이미지 업로드 오류:', error);
                    alert('이미지 업로드 중 오류가 발생했습니다: ' + error.message);
                    return null;
                }
            }
        
            window.saveQuestion = async () => {
                const title = document.getElementById('questionTitle').value.trim();
                if (!title) return alert('문제 제목을 입력하세요');
                
                // 업로드 중 표시
                const saveBtn = document.querySelector('button[onclick="saveQuestion()"]');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = '업로드 중...';
                saveBtn.disabled = true;
                
                try {
                    let imageUrl = null;
                    
                    // 편집 모드이면서 새 이미지가 선택되지 않은 경우
                    if (editingId) {
                        const existingDoc = await getDoc(doc(db, 'questions', editingId));
                        const existingData = existingDoc.data();
                        imageUrl = existingData.imageUrl; // 기존 이미지 URL 유지
                    }
                    
                    // 새 이미지가 선택된 경우에만 업로드
                    const fileInput = document.getElementById('questionImage');
                    if (fileInput.files[0]) {
                        imageUrl = await uploadImageToStorage();
                    }
                    
                    const data = {
                        title: title,
                        correctAnswer: document.getElementById('correctAnswer').value,
                        isBonus: document.getElementById('isBonus').checked,
                        imageUrl: imageUrl,
                        createdAt: serverTimestamp(),
                        order: questions.length
                    };
                    
                    const id = editingId || `q_${Date.now()}`;
                    await setDoc(doc(db, 'questions', id), data);
                    
                    cancelForm();
                    await loadQuestions();
                    
                } catch (error) {
                    console.error('문제 저장 오류:', error);
                    alert('문제 저장 중 오류가 발생했습니다.');
                } finally {
                    // 버튼 복구
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                }
            };

            window.cancelForm = () => {
                document.getElementById('questionForm').classList.add('hidden');
                document.getElementById('btnToggle').textContent = '+ 새 문제';
                document.getElementById('btnToggle').className = 'px-4 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600';
                document.getElementById('questionTitle').value = '';
                document.getElementById('correctAnswer').value = 'O';
                document.getElementById('questionImage').value = '';
                document.getElementById('imagePreview').classList.add('hidden');
                
                // 기존 이미지 정보 텍스트 제거
                const existingImageInfo = document.getElementById('existingImageInfo');
                if (existingImageInfo) {
                    existingImageInfo.remove();
                }
                
                document.getElementById('isBonus').checked = false;
                editingId = null;
            };

        // 문제 목록 로드
        async function loadQuestions() {
            const snapshot = await getDocs(query(collection(db, 'questions'), orderBy('order')));
            questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // 드롭다운 업데이트
            const select = document.getElementById('questionSelect');
            select.innerHTML = '<option value="">문제를 선택하세요</option>' + 
                questions.map((q, i) => `<option value="${q.id}">${i + 1}. ${q.title} ${q.isBonus ? '⭐' : ''}</option>`).join('');
            
            // 목록 업데이트
            const list = document.getElementById('questionList');
            if (questions.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-8">저장된 문제가 없습니다</div>';
            } else {
                list.innerHTML = questions.map((q, i) => `
                    <div class="border bg-white p-3 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="font-medium">${i + 1}. ${q.title} ${q.isBonus ? '⭐' : ''}</div>
                                <div class="text-xs text-gray-500">정답: ${q.correctAnswer}</div>
                            </div>
                            <div class="flex space-x-1">
                                <button onclick="editQuestion('${q.id}')" class="px-2 py-1 bg-yellow-500 text-white rounded text-xs">수정</button>
                                <button onclick="deleteQuestion('${q.id}')" class="px-2 py-1 bg-red-500 text-white rounded text-xs">삭제</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            updateUI();
        }

        // 문제 수정/삭제
        window.editQuestion = async (id) => {
            const questionDoc = await getDoc(doc(db, 'questions', id));
            const data = questionDoc.data();
            
            document.getElementById('questionTitle').value = data.title;
            document.getElementById('correctAnswer').value = data.correctAnswer;
            document.getElementById('isBonus').checked = data.isBonus || false;
            
            // 파일 input은 초기화 (보안상 값을 설정할 수 없음)
            document.getElementById('questionImage').value = '';
            
            // 기존 이미지가 있으면 미리보기 표시
            if (data.imageUrl) {
                document.getElementById('previewImg').src = data.imageUrl;
                document.getElementById('imagePreview').classList.remove('hidden');
                
                // 기존 이미지 표시를 위한 텍스트 추가
                const existingImageDiv = document.getElementById('existingImageInfo') || (() => {
                    const div = document.createElement('div');
                    div.id = 'existingImageInfo';
                    div.className = 'text-sm text-blue-600 mb-2';
                    document.getElementById('imagePreview').appendChild(div);
                    return div;
                })();
                existingImageDiv.textContent = '기존 이미지 (새 이미지를 선택하면 교체됩니다)';
            } else {
                document.getElementById('imagePreview').classList.add('hidden');
            }
            
            editingId = id;
            toggleForm();
        };

        window.deleteQuestion = async (id) => {
            if (confirm('정말 삭제하시겠습니까?')) {
                await deleteDoc(doc(db, 'questions', id));
                await loadQuestions();
            }
        };

        // 실시간 현황 - 실시간 업데이트 지원
        function updateStats(snapshot) {
            if (!currentQuestion || currentQuestion.status !== 'active') {
                document.getElementById('liveStats').innerHTML = '<div class="text-center text-gray-500 py-8">문제가 진행되지 않고 있습니다</div>';
                return;
            }
            
            const answers = { O: [], X: [] };
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.questionId === currentQuestion.id) {
                    answers[data.answer].push({
                        name: data.userName,
                        position: data.userPosition
                    });
                }
            });
            
            const total = answers.O.length + answers.X.length;
            const correct = answers[currentQuestion.correctAnswer].length;
            
            let html = `
                <div class="text-center mb-4">
                    <div class="font-bold">${currentQuestion.title}</div>
                    <div class="text-sm text-gray-600">총 ${total}명 참여 | 정답률: ${total ? Math.round(correct/total*100) : 0}%</div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-100 p-4 rounded">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">O</div>
                            <div class="font-bold mb-2">${answers.O.length}명</div>
                        </div>
                        <div class="text-xs text-gray-600 max-h-32 overflow-y-auto">
                            ${answers.O.map(user => `<span class="inline-block bg-blue-200 px-2 py-1 rounded mr-1 mb-1">${user.name}</span>`).join('')}
                        </div>
                    </div>
                    <div class="bg-red-100 p-4 rounded">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600">X</div>
                            <div class="font-bold mb-2">${answers.X.length}명</div>
                        </div>
                        <div class="text-xs text-gray-600 max-h-32 overflow-y-auto">
                            ${answers.X.map(user => `<span class="inline-block bg-red-200 px-2 py-1 rounded mr-1 mb-1">${user.name}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
            
           
            document.getElementById('liveStats').innerHTML = html;
        }

        // 사용자 관리 - 개선된 디자인
        function updateUsers(snapshot) {
            const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (showRankingMode) {
                // 랭킹 모드
                document.getElementById('userList').innerHTML = users.length ? users.map((user, index) => {
                    const rankClass = index < 3 ? 'bg-gradient-to-r from-yellow-100 to-yellow-50 border-yellow-200' : 'bg-white border-gray-200';
                    const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '';
                    return `
                        <div class="flex items-center justify-between p-3 border rounded-lg ${rankClass}">
                            <div class="flex items-center space-x-3">
                                <div class="text-2xl font-bold text-gray-600">${index + 1}</div>
                                <div class="text-xl">${medal}</div>
                                <div>
                                    <div class="font-medium">${user.name}</div>
                                    <div class="text-xs text-gray-500">${user.position}</div>
                                </div>
                            </div>
                            <div class="text-xl font-bold text-blue-600">${user.score || 0}점</div>
                        </div>
                    `;
                }).join('') : '<div class="text-center text-gray-500 py-8">참가자가 없습니다</div>';
            } else {
            document.getElementById('userList').innerHTML = users.length ? users.map(user => {
                const status = user.isFrozen ? '🚫' : (user.isOnline ? '🟢' : '⚪');
                return `
                    <div class="flex justify-between items-center p-3 border rounded-lg ${user.isFrozen ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200'} transition-all hover:shadow-md">
                        <div class="flex-1">
                            <div class="font-medium text-sm flex items-center">
                                ${user.name} 
                                <span class="ml-2">${status}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">${user.position} | ${user.score || 0}점</div>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <button onclick="adjustScore('${user.id}', '${user.name}')" 
                                    class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded-md text-xs font-medium transition-colors">
                                점수
                            </button>
                            <button onclick="toggleFreeze('${user.id}', '${user.name}', ${user.isFrozen || false})" 
                                    class="px-3 py-1.5 ${user.isFrozen ? 'bg-green-500 hover:bg-green-600' : 'bg-orange-500 hover:bg-orange-600'} text-white rounded-md text-xs font-medium transition-colors">
                                ${user.isFrozen ? '해제' : '동결'}
                            </button>
                            <button onclick="deleteUser('${user.id}', '${user.name}')" 
                                    class="btn-danger">
                                삭제
                            </button>
                        </div>
                    </div>
                `;
            }).join('') : '<div class="text-center text-gray-500 py-8">참가자가 없습니다</div>';
            }
        }
        // 사용자 관리 함수들
        window.adjustScore = async (id, name) => {
            const newScore = prompt(`${name}의 새 점수:`);
            if (newScore !== null && !isNaN(newScore)) {
                await updateDoc(doc(db, 'users', id), { score: parseInt(newScore) });
            }
        };

        window.toggleFreeze = async (id, name, frozen) => {
            if (confirm(`${name}을 ${frozen ? '해제' : '동결'}하시겠습니까?`)) {
                await updateDoc(doc(db, 'users', id), { isFrozen: !frozen });
            }
        };

        window.deleteUser = async (id, name) => {
            if (!confirm(`정말 ${name} 사용자를 완전히 삭제하시겠습니까?\n삭제된 사용자는 복구할 수 없습니다.`)) {
                return;
            }
            
            try {
                // 사용자 문서 삭제
                await deleteDoc(doc(db, 'users', id));
                
                // 해당 사용자의 모든 답변도 삭제
                const userAnswers = await getDocs(query(collection(db, 'answers'), where('userId', '==', id)));
                const batch = writeBatch(db);
                userAnswers.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                alert(`${name} 사용자가 삭제되었습니다.`);
            } catch (error) {
                console.error('사용자 삭제 오류:', error);
                alert('사용자 삭제 중 오류가 발생했습니다.');
            }
        };

        // 로그아웃
        window.logout = () => {
            listeners.forEach(unsubscribe => unsubscribe());
            listeners = [];
            document.getElementById('adminApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminPassword').value = '';
        };

        // Enter 키 이벤트
        document.getElementById('adminPassword').addEventListener('keypress', e => e.key === 'Enter' && login());


    </script>
</body>
</html>
