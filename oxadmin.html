<!DOCTYPE html>
<html lang="ko" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <title>OX í€´ì¦ˆ ê´€ë¦¬ì</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .header-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .status-waiting { background: #fbbf24; }
        .status-active { background: #3b82f6; }
        .status-ended { background: #ef4444; }
        .pulse { animation: pulse 2s infinite; }
        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%);
            transform: translateY(-1px);
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        
    </style>
</head>
<body class="min-h-screen">
    <!-- ë¡œê·¸ì¸ -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-6">
        <div class="card rounded-3xl p-8 w-full max-w-md">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">OX í€´ì¦ˆ ê´€ë¦¬ì</h1>
            <input type="password" id="adminPassword" class="w-full px-4 py-3 border rounded-xl mb-4" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸">
            <button onclick="login()" class="w-full py-3 bg-blue-500 text-white rounded-xl font-semibold hover:bg-blue-600">ë¡œê·¸ì¸</button>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ë©”ì¸ -->
    <div id="adminApp" class="hidden min-h-screen flex flex-col">
        <!-- í—¤ë” -->
        <div class="header-gradient p-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-white">OX í€´ì¦ˆ ê´€ë¦¬ì</h1>
                    <div class="flex items-center mt-1">
                        <div id="statusDot" class="w-3 h-3 rounded-full mr-2 status-waiting"></div>
                        <span class="text-white text-opacity-80" id="statusText">ëŒ€ê¸° ì¤‘</span>
                    </div>
                </div>
                <button onclick="logout()" class="text-white text-opacity-70 hover:text-white">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="flex-1 p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- ê²Œì„ ì œì–´ -->
                <div class="card rounded-3xl p-6">
                    <h2 class="text-xl font-bold mb-4">ê²Œì„ ì œì–´</h2>
                    
                    <!-- ë¬¸ì œ ì„ íƒ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">ë¬¸ì œ ì„ íƒ</label>
                        <select id="questionSelect" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">ë¬¸ì œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    
                    <!-- ë³´ë„ˆìŠ¤ í† ê¸€ -->
                    <div class="mb-6 p-3 bg-orange-50 rounded-lg">
                        <label class="flex items-center">
                            <input type="checkbox" id="bonusToggle" class="mr-2">
                            <span class="text-orange-800">â­ ë³´ë„ˆìŠ¤ ë¬¸ì œ (2ë°° ì ìˆ˜)</span>
                        </label>
                    </div>
                    
                    <!-- ì œì–´ ë²„íŠ¼ -->
                    <div class="space-y-3">
                        <button onclick="startQuestion()" id="btnStart" class="w-full py-3 bg-green-500 text-white rounded-xl font-semibold hover:bg-green-600">ğŸš€ ë¬¸ì œ ì‹œì‘</button>
                        <button onclick="endQuestion()" id="btnEnd" disabled class="w-full py-3 bg-orange-500 text-white rounded-xl font-semibold disabled:bg-gray-400">â¹ï¸ ë¬¸ì œ ì¢…ë£Œ</button>
                        <button onclick="nextQuestion()" id="btnNext" disabled class="w-full py-3 bg-blue-500 text-white rounded-xl font-semibold disabled:bg-gray-400">ğŸ“ ë‹¤ìŒ ë¬¸ì œ</button>
                        <button onclick="resetGame()" class="w-full py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600">ğŸ”„ ì „ì²´ ë¦¬ì…‹</button>
                    </div>
                    
                    <!-- í˜„ì¬ ë¬¸ì œ ì •ë³´ -->
                    <div class="mt-6">
                        <h3 class="font-bold mb-2">í˜„ì¬ ë¬¸ì œ</h3>
                        <div id="currentQuestionInfo" class="text-gray-500 text-sm">ì„ íƒëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                </div>

                <!-- ë¬¸ì œ ê´€ë¦¬ -->
                <div class="card rounded-3xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">ë¬¸ì œ ê´€ë¦¬</h2>
                        <button onclick="toggleForm()" id="btnToggle" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">+ ìƒˆ ë¬¸ì œ</button>
                    </div>
                    
                    <!-- ë¬¸ì œ ì¶”ê°€ í¼ -->
                    <div id="questionForm" class="hidden mb-4 p-4 bg-gray-50 rounded-lg">
                        <input type="text" id="questionTitle" class="w-full px-3 py-2 border rounded-lg mb-3" placeholder="ë¬¸ì œ ì œëª©">
                        <select id="correctAnswer" class="w-full px-3 py-2 border rounded-lg mb-3">
                            <option value="O">O</option>
                            <option value="X">X</option>
                        </select>
                        <label class="flex items-center mb-3">
                            <input type="checkbox" id="isBonus" class="mr-2">
                            <span class="text-sm">ê¸°ë³¸ ë³´ë„ˆìŠ¤ ë¬¸ì œ</span>
                        </label>
                        <div class="flex space-x-2">
                            <button onclick="saveQuestion()" class="flex-1 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600">ì €ì¥</button>
                            <button onclick="cancelForm()" class="px-4 py-2 bg-gray-500 text-white rounded-lg text-sm hover:bg-gray-600">ì·¨ì†Œ</button>
                        </div>
                    </div>
                    
                    <!-- ë¬¸ì œ ëª©ë¡ -->
                    <div id="questionList" class="space-y-2 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 py-8">ì €ì¥ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                </div>

                <!-- ì‹¤ì‹œê°„ í˜„í™© & ë­í‚¹ -->
                <div class="space-y-6">
                    <!-- ì‹¤ì‹œê°„ í˜„í™© -->
                    <div class="card rounded-3xl p-6">
                        <h2 class="text-xl font-bold mb-4">ì‹¤ì‹œê°„ í˜„í™©</h2>
                        <div id="liveStats">
                            <div class="text-center text-gray-500 py-8">ë¬¸ì œê°€ ì§„í–‰ë˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤</div>
                        </div>
                    </div>
                    
                    <!-- ì‚¬ìš©ì ê´€ë¦¬ -->
                    <div class="card rounded-3xl p-6">
                        <h2 class="text-xl font-bold mb-4">ì‚¬ìš©ì ê´€ë¦¬</h2>
                        <div id="userList" class="space-y-2 max-h-64 overflow-y-auto">
                            <div class="text-center text-gray-500 py-8">ì‚¬ìš©ìë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, orderBy, updateDoc, deleteDoc, getDocs, writeBatch, increment, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        const app = initializeApp({
            apiKey: "AIzaSyA_SuKTn4jWyBL3lyk8CK6hPpttpR0MOMc",
            authDomain: "quizland-hyogi.firebaseapp.com",
            projectId: "quizland-hyogi",
            storageBucket: "quizland-hyogi.firebasestorage.app",
            messagingSenderId: "886372179569",
            appId: "1:886372179569:web:8616d019f7b63a26e045d0"
        });
        const db = getFirestore(app);

        let currentQuestion = null, questions = [], listeners = [], editingId = null;

        // ë¡œê·¸ì¸
        window.login = () => {
            if (document.getElementById('adminPassword').value === 'admin123') {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminApp').classList.remove('hidden');
                init();
            } else alert('ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.');
        };

        // ì´ˆê¸°í™”
        async function init() {
            setupListeners();
            await loadQuestions();
        }

        // ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupListeners() {
            const questionListener = onSnapshot(doc(db, 'system', 'currentQuestion'), (doc) => {
                currentQuestion = doc.exists() ? doc.data() : null;
                updateUI();
            });
            
            const answersListener = onSnapshot(collection(db, 'answers'), updateStats);
            const usersListener = onSnapshot(query(collection(db, 'users'), orderBy('score', 'desc')), updateUsers);
            
            listeners = [questionListener, answersListener, usersListener];
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const btnStart = document.getElementById('btnStart');
            const btnEnd = document.getElementById('btnEnd');
            const btnNext = document.getElementById('btnNext');
            const info = document.getElementById('currentQuestionInfo');

            if (!currentQuestion) {
                statusDot.className = 'w-3 h-3 rounded-full mr-2 status-waiting';
                statusText.textContent = 'ëŒ€ê¸° ì¤‘';
                btnStart.disabled = questions.length === 0;
                btnEnd.disabled = true;
                btnNext.disabled = true;
                info.textContent = 'ì„ íƒëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤';
            } else if (currentQuestion.status === 'active') {
                statusDot.className = 'w-3 h-3 rounded-full mr-2 status-active pulse';
                statusText.textContent = 'ë¬¸ì œ ì§„í–‰ ì¤‘';
                btnStart.disabled = true;
                btnEnd.disabled = false;
                btnNext.disabled = true;
                const bonus = currentQuestion.isBonus ? ' â­' : '';
                info.innerHTML = `<div class="bg-blue-50 p-3 rounded">${currentQuestion.title}<br>ì •ë‹µ: ${currentQuestion.correctAnswer}${bonus}</div>`;
            } else if (currentQuestion.status === 'ended') {
                statusDot.className = 'w-3 h-3 rounded-full mr-2 status-ended';
                statusText.textContent = 'ë¬¸ì œ ì¢…ë£Œë¨';
                btnStart.disabled = true;
                btnEnd.disabled = true;
                btnNext.disabled = false;
                info.innerHTML = `<div class="bg-green-50 p-3 rounded">ë¬¸ì œ ì¢…ë£Œë¨<br>ì •ë‹µ: ${currentQuestion.correctAnswer}</div>`;
            }
        }

        // ë¬¸ì œ ì‹œì‘
        window.startQuestion = async () => {
            const questionId = document.getElementById('questionSelect').value;
            if (!questionId) return alert('ë¬¸ì œë¥¼ ì„ íƒí•˜ì„¸ìš”');
            
            const question = questions.find(q => q.id === questionId);
            const isBonus = document.getElementById('bonusToggle').checked || question.isBonus;
            
            // ì´ì „ ë‹µë³€ ì‚­ì œ
            const answers = await getDocs(collection(db, 'answers'));
            const batch = writeBatch(db);
            answers.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            
            // ìƒˆ ë¬¸ì œ ì‹œì‘ (ë²ˆí˜¸ ì œê±°)
            await setDoc(doc(db, 'system', 'currentQuestion'), {
                id: `q_${Date.now()}`,
                title: question.title,
                correctAnswer: question.correctAnswer,
                isBonus: isBonus,
                status: 'active',
                startTime: serverTimestamp()
            });
            
            document.getElementById('bonusToggle').checked = false;
        };

        // ìˆ˜ì •ëœ ì½”ë“œ
        window.endQuestion = async () => {
            if (!currentQuestion) return;
            
            console.log('ë¬¸ì œ ì¢…ë£Œ ì‹œì‘');
            
            // ë¨¼ì € ì ìˆ˜ ê³„ì‚°
            await calculateScores();
            
            // ê·¸ ë‹¤ìŒ ë¬¸ì œ ìƒíƒœë¥¼ ì¢…ë£Œë¡œ ë³€ê²½
            await updateDoc(doc(db, 'system', 'currentQuestion'), { 
                status: 'ended', 
                endTime: serverTimestamp() 
            });
            
            console.log('ë¬¸ì œ ì¢…ë£Œ ì™„ë£Œ');
        };

        // ìˆ˜ì •ëœ ì½”ë“œ
        async function calculateScores() {
            if (!currentQuestion) {
                console.log('í˜„ì¬ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            try {
                console.log('ì ìˆ˜ ê³„ì‚° ì‹œì‘ - ë¬¸ì œ ID:', currentQuestion.id);
                console.log('ì •ë‹µ:', currentQuestion.correctAnswer);
                
                const answers = await getDocs(collection(db, 'answers'));
                const points = currentQuestion.isBonus ? 2 : 1;
                
                let correctCount = 0;
                let totalCount = 0;
                
                // batch ëŒ€ì‹  ê°œë³„ ì—…ë°ì´íŠ¸ë¡œ ë³€ê²½
                const updatePromises = [];
                
                answers.forEach(answerDoc => {  // íŒŒë¼ë¯¸í„° ì´ë¦„ ë³€ê²½
                    const answer = answerDoc.data();
                    console.log('ë‹µë³€ í™•ì¸:', answer);
                    
                    if (answer.questionId === currentQuestion.id) {
                        totalCount++;
                        console.log(`${answer.userName}ì˜ ë‹µë³€: ${answer.answer}`);
                        
                        if (answer.answer === currentQuestion.correctAnswer) {
                            correctCount++;
                            console.log(`${answer.userName} ì •ë‹µ! ${points}ì  ì¶”ê°€`);
                            
                            // doc í•¨ìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì‚¬ìš©
                            const userRef = doc(db, 'users', answer.userId);
                            updatePromises.push(updateDoc(userRef, { 
                                score: increment(points)
                            }));
                        }
                    }
                });
                
                // ëª¨ë“  ì—…ë°ì´íŠ¸ ì‹¤í–‰
                await Promise.all(updatePromises);
                console.log(`ì ìˆ˜ ê³„ì‚° ì™„ë£Œ: ${correctCount}/${totalCount}ëª… ì •ë‹µ, ${points}ì ì”© ì§€ê¸‰`);
                
            } catch (error) {
                console.error('ì ìˆ˜ ê³„ì‚° ì˜¤ë¥˜:', error);
            }
        }

        // ë‹¤ìŒ ë¬¸ì œ
        window.nextQuestion = async () => {
            await deleteDoc(doc(db, 'system', 'currentQuestion'));
            document.getElementById('questionSelect').value = '';
        };

        // ì „ì²´ ë¦¬ì…‹
        window.resetGame = async () => {
            if (!confirm('ì •ë§ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            const answers = await getDocs(collection(db, 'answers'));
            const batch = writeBatch(db);
            answers.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            
            await deleteDoc(doc(db, 'system', 'currentQuestion'));
            document.getElementById('questionSelect').value = '';
        };

        // ë¬¸ì œ ê´€ë¦¬
        window.toggleForm = () => {
            const form = document.getElementById('questionForm');
            const btn = document.getElementById('btnToggle');
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.textContent = 'ì·¨ì†Œ';
                btn.className = 'px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600';
            } else cancelForm();
        };

        window.saveQuestion = async () => {
            const title = document.getElementById('questionTitle').value.trim();
            if (!title) return alert('ë¬¸ì œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
            
            const data = {
                title: title,
                correctAnswer: document.getElementById('correctAnswer').value,
                isBonus: document.getElementById('isBonus').checked,
                createdAt: serverTimestamp(),
                order: questions.length
            };
            
            const id = editingId || `q_${Date.now()}`;
            await setDoc(doc(db, 'questions', id), data);
            
            cancelForm();
            await loadQuestions();
        };

        window.cancelForm = () => {
            document.getElementById('questionForm').classList.add('hidden');
            document.getElementById('btnToggle').textContent = '+ ìƒˆ ë¬¸ì œ';
            document.getElementById('btnToggle').className = 'px-4 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600';
            document.getElementById('questionTitle').value = '';
            document.getElementById('correctAnswer').value = 'O';
            document.getElementById('isBonus').checked = false;
            editingId = null;
        };

        // ë¬¸ì œ ëª©ë¡ ë¡œë“œ
        async function loadQuestions() {
            const snapshot = await getDocs(query(collection(db, 'questions'), orderBy('order')));
            questions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
            const select = document.getElementById('questionSelect');
            select.innerHTML = '<option value="">ë¬¸ì œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>' + 
                questions.map((q, i) => `<option value="${q.id}">${i + 1}. ${q.title} ${q.isBonus ? 'â­' : ''}</option>`).join('');
            
            // ëª©ë¡ ì—…ë°ì´íŠ¸
            const list = document.getElementById('questionList');
            if (questions.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-8">ì €ì¥ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            } else {
                list.innerHTML = questions.map((q, i) => `
                    <div class="border bg-white p-3 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="font-medium">${i + 1}. ${q.title} ${q.isBonus ? 'â­' : ''}</div>
                                <div class="text-xs text-gray-500">ì •ë‹µ: ${q.correctAnswer}</div>
                            </div>
                            <div class="flex space-x-1">
                                <button onclick="editQuestion('${q.id}')" class="px-2 py-1 bg-yellow-500 text-white rounded text-xs">ìˆ˜ì •</button>
                                <button onclick="deleteQuestion('${q.id}')" class="px-2 py-1 bg-red-500 text-white rounded text-xs">ì‚­ì œ</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            updateUI();
        }

        // ë¬¸ì œ ìˆ˜ì •/ì‚­ì œ
        window.editQuestion = async (id) => {
            const questionDoc = await getDoc(doc(db, 'questions', id));
            const data = questionDoc.data();
            
            document.getElementById('questionTitle').value = data.title;
            document.getElementById('correctAnswer').value = data.correctAnswer;
            document.getElementById('isBonus').checked = data.isBonus || false;
            
            editingId = id;
            toggleForm();
        };

        window.deleteQuestion = async (id) => {
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await deleteDoc(doc(db, 'questions', id));
                await loadQuestions();
            }
        };

        // ì‹¤ì‹œê°„ í˜„í™© - ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì§€ì›
        function updateStats(snapshot) {
            if (!currentQuestion || currentQuestion.status !== 'active') {
                document.getElementById('liveStats').innerHTML = '<div class="text-center text-gray-500 py-8">ë¬¸ì œê°€ ì§„í–‰ë˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            const answers = { O: [], X: [] };
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.questionId === currentQuestion.id) {
                    answers[data.answer].push({
                        name: data.userName,
                        position: data.userPosition
                    });
                }
            });
            
            const total = answers.O.length + answers.X.length;
            const correct = answers[currentQuestion.correctAnswer].length;
            
            let html = `
                <div class="text-center mb-4">
                    <div class="font-bold">${currentQuestion.title}</div>
                    <div class="text-sm text-gray-600">ì´ ${total}ëª… ì°¸ì—¬ | ì •ë‹µë¥ : ${total ? Math.round(correct/total*100) : 0}%</div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-blue-100 p-4 rounded text-center">
                        <div class="text-2xl font-bold text-blue-600">O</div>
                        <div class="font-bold">${answers.O.length}ëª…</div>
                    </div>
                    <div class="bg-red-100 p-4 rounded text-center">
                        <div class="text-2xl font-bold text-red-600">X</div>
                        <div class="font-bold">${answers.X.length}ëª…</div>
                    </div>
                </div>
            `;
            
            // O ì„ íƒì ëª©ë¡
            if (answers.O.length > 0) {
                html += `
                    <div class="mb-3">
                        <div class="font-medium text-blue-600 mb-1 text-sm">O ì„ íƒì (${answers.O.length}ëª…):</div>
                        <div class="text-xs text-gray-600">
                `;
                answers.O.forEach(user => {
                    html += `<span class="inline-block bg-blue-100 px-2 py-1 rounded mr-1 mb-1">${user.name}</span>`;
                });
                html += '</div></div>';
            }
            
            // X ì„ íƒì ëª©ë¡
            if (answers.X.length > 0) {
                html += `
                    <div>
                        <div class="font-medium text-red-600 mb-1 text-sm">X ì„ íƒì (${answers.X.length}ëª…):</div>
                        <div class="text-xs text-gray-600">
                `;
                answers.X.forEach(user => {
                    html += `<span class="inline-block bg-red-100 px-2 py-1 rounded mr-1 mb-1">${user.name}</span>`;
                });
                html += '</div></div>';
            }
            
            document.getElementById('liveStats').innerHTML = html;
        }

        // ì‚¬ìš©ì ê´€ë¦¬ - ê°œì„ ëœ ë””ìì¸
        function updateUsers(snapshot) {
            const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            document.getElementById('userList').innerHTML = users.length ? users.map(user => {
                const status = user.isFrozen ? 'ğŸš«' : (user.isOnline ? 'ğŸŸ¢' : 'âšª');
                return `
                    <div class="flex justify-between items-center p-3 border rounded-lg ${user.isFrozen ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200'} transition-all hover:shadow-md">
                        <div class="flex-1">
                            <div class="font-medium text-sm flex items-center">
                                ${user.name} 
                                <span class="ml-2">${status}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">${user.position} | ${user.score || 0}ì </div>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <button onclick="adjustScore('${user.id}', '${user.name}')" 
                                    class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded-md text-xs font-medium transition-colors">
                                ì ìˆ˜
                            </button>
                            <button onclick="toggleFreeze('${user.id}', '${user.name}', ${user.isFrozen || false})" 
                                    class="px-3 py-1.5 ${user.isFrozen ? 'bg-green-500 hover:bg-green-600' : 'bg-orange-500 hover:bg-orange-600'} text-white rounded-md text-xs font-medium transition-colors">
                                ${user.isFrozen ? 'í•´ì œ' : 'ë™ê²°'}
                            </button>
                            <button onclick="deleteUser('${user.id}', '${user.name}')" 
                                    class="btn-danger">
                                ì‚­ì œ
                            </button>
                        </div>
                    </div>
                `;
            }).join('') : '<div class="text-center text-gray-500 py-8">ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        }

        // ì‚¬ìš©ì ê´€ë¦¬ í•¨ìˆ˜ë“¤
        window.adjustScore = async (id, name) => {
            const newScore = prompt(`${name}ì˜ ìƒˆ ì ìˆ˜:`);
            if (newScore !== null && !isNaN(newScore)) {
                await updateDoc(doc(db, 'users', id), { score: parseInt(newScore) });
            }
        };

        window.toggleFreeze = async (id, name, frozen) => {
            if (confirm(`${name}ì„ ${frozen ? 'í•´ì œ' : 'ë™ê²°'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                await updateDoc(doc(db, 'users', id), { isFrozen: !frozen });
            }
        };

        window.deleteUser = async (id, name) => {
            if (!confirm(`ì •ë§ ${name} ì‚¬ìš©ìë¥¼ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ì‚¬ìš©ìëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }
            
            try {
                // ì‚¬ìš©ì ë¬¸ì„œ ì‚­ì œ
                await deleteDoc(doc(db, 'users', id));
                
                // í•´ë‹¹ ì‚¬ìš©ìì˜ ëª¨ë“  ë‹µë³€ë„ ì‚­ì œ
                const userAnswers = await getDocs(query(collection(db, 'answers'), where('userId', '==', id)));
                const batch = writeBatch(db);
                userAnswers.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                alert(`${name} ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                console.error('ì‚¬ìš©ì ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚¬ìš©ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        // ë¡œê·¸ì•„ì›ƒ
        window.logout = () => {
            listeners.forEach(unsubscribe => unsubscribe());
            listeners = [];
            document.getElementById('adminApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminPassword').value = '';
        };

        // Enter í‚¤ ì´ë²¤íŠ¸
        document.getElementById('adminPassword').addEventListener('keypress', e => e.key === 'Enter' && login());
    </script>
</body>
</html>
